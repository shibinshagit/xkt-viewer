<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIM Explorer Pro</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;700&display=swap">
    <style>
        :root {
            --primary: #00e5ff;
            --primary-dark: #00b8d4;
            --secondary: #7c4dff;
            --secondary-dark: #651fff;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #e0e0e0;
            --accent: #ff1744;
            --success: #00e676;
            --warning: #ffea00;
            --info: #2979ff;
            --panel-bg: rgba(18, 18, 24, 0.85);
            --panel-border: rgba(0, 229, 255, 0.3);
            --glow: 0 0 10px rgba(0, 229, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            background-color: var(--darker);
            height: 100vh;
            color: var(--light);
        }

        #myCanvas {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
        }

        #dropZone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(10, 10, 15, 0.8);
            color: white;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            pointer-events: none;
            opacity: 0;
        }

        #dropZone.active {
            opacity: 1;
            pointer-events: all;
        }

        #dropZone.highlight {
            background-color: rgba(0, 229, 255, 0.2);
        }

        #dropZone i {
            font-size: 5rem;
            margin-bottom: 1rem;
            color: var(--primary);
            filter: drop-shadow(0 0 10px rgba(0, 229, 255, 0.5));
        }

        #dropZone p {
            font-size: 1.5rem;
            text-align: center;
            max-width: 80%;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #splashScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(18, 18, 24, 0.95) 0%, rgba(10, 10, 15, 0.95) 100%);
            z-index: 900;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        #splashScreen.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        #logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary);
            text-shadow: 0 0 15px rgba(0, 229, 255, 0.7);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        #logo span {
            color: var(--light);
        }

        #splashScreen p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: var(--light);
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            padding: 0 20px;
        }

        #uploadButton {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
        }

        #uploadButton:hover {
            background-color: var(--primary);
            color: var(--dark);
            box-shadow: var(--glow);
        }

        #uploadButton i {
            margin-right: 10px;
        }

        #myNavCubeCanvas {
            position: absolute;
            width: 150px;
            height: 150px;
            bottom: 50px;
            right: 20px;
            z-index: 100;
            background-color: rgba(18, 18, 24, 0.3);
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--panel-border);
            transition: all 0.3s ease;
        }

        #myNavCubeCanvas:hover {
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.3);
        }

        #treeViewContainer {
            pointer-events: all;
            height: calc(100% - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            position: absolute;
            background-color: var(--panel-bg);
            color: var(--light);
            top: 70px;
            z-index: 100;
            left: 0;
            padding: 20px;
            font-size: 14px;
            user-select: none;
            width: 350px;
            border-radius: 0 8px 8px 0;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
            transform: translateX(-360px);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border-right: 1px solid var(--panel-border);
        }

        #treeViewContainer.visible {
            transform: translateX(0);
        }

        #treeViewHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #treeViewHeader h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #treeViewHeader div {
            display: flex;
            gap: 10px;
        }

        #treeViewHeader button {
            background: none;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s;
        }

        #treeViewHeader button:hover {
            color: var(--primary);
        }

        #treeViewContainer ul {
            list-style: none;
            padding-left: 1.5em;
        }

        #treeViewContainer ul li {
            position: relative;
            width: calc(100% - 10px);
            padding: 4px 0;
            vertical-align: middle;
        }

        #treeViewContainer ul li a {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: var(--light);
            display: inline-block;
            height: 1.5em;
            left: -1.5em;
            position: absolute;
            text-align: center;
            text-decoration: none;
            width: 1.5em;
            pointer-events: all;
            transition: all 0.2s;
        }

        #treeViewContainer ul li a.plus {
            background-color: rgba(0, 229, 255, 0.2);
        }

        #treeViewContainer ul li a.minus {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #treeViewContainer ul li a:hover {
            background-color: var(--primary);
            color: var(--dark);
        }

        #treeViewContainer ul li span {
            display: inline-block;
            width: calc(100% - 20px);
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        #treeViewContainer ul li span:hover {
            color: var(--primary);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
        }

        #treeViewContainer .highlighted-node {
            border: var(--primary) solid 1px;
            background: rgba(0, 229, 255, 0.1);
            color: var(--primary);
        }

        /* Model-specific controls in tree view */
        .model-controls {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
        }

        .model-controls button {
            background: none;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .model-controls button:hover {
            color: var(--primary);
        }

        #toolbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--panel-bg);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
            z-index: 200;
            border-bottom: 1px solid var(--panel-border);
        }

        #toolbar h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 600;
            flex-grow: 1;
            font-family: 'Orbitron', sans-serif;
            color: var(--light);
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }

        #toolbar h1 span {
            color: var(--primary);
        }

        .toolbar-button {
            background: none;
            border: 1px solid transparent;
            color: var(--light);
            font-size: 1.1rem;
            cursor: pointer;
            width: 45px;
            height: 45px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .toolbar-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--panel-border);
            color: var(--primary);
        }

        .toolbar-button.active {
            background-color: rgba(0, 229, 255, 0.15);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .toolbar-button .tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--panel-bg);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            border: 1px solid var(--panel-border);
            z-index: 300;
        }

        .toolbar-button:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        #statusBar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background-color: var(--panel-bg);
            color: var(--light);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 0.9rem;
            z-index: 200;
            border-top: 1px solid var(--panel-border);
            overflow-x: auto;
            white-space: nowrap;
        }

        #status {
            flex-grow: 1;
            display: flex;
            align-items: center;
            min-width: 100px;
        }

        #status i {
            margin-right: 8px;
            color: var(--primary);
        }

        #stats {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        #stats .stat {
            display: flex;
            align-items: center;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        #stats .stat i {
            margin-right: 8px;
            color: var(--primary);
            flex-shrink: 0;
        }

        .stat a {
            margin-left: 5px;
            color: #888;
            text-decoration: none;
        }

        .stat a:hover {
            text-decoration: underline;
        }

        #fileInput {
            display: none;
        }

        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 15, 0.85);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #loadingOverlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 229, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }

        #loadingStatus {
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            padding: 0 20px;
        }

        #loadingProgress {
            width: 80%;
            max-width: 300px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        #loadingProgressBar {
            height: 100%;
            width: 0%;
            background-color: var(--primary);
            transition: width 0.3s;
            box-shadow: 0 0 10px var(--primary);
        }

        #quickActions {
            position: absolute;
            right: 20px;
            top: 90px;
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            border: 1px solid var(--panel-border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .quick-action {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            background: none;
            border: 1px solid transparent;
            color: var(--light);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .quick-action:last-child {
            margin-bottom: 0;
        }

        .quick-action:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--panel-border);
            color: var(--primary);
        }

        .quick-action.active {
            background-color: rgba(0, 229, 255, 0.15);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .quick-action .tooltip {
            position: absolute;
            right: 55px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--panel-bg);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            border: 1px solid var(--panel-border);
            z-index: 300;
        }

        .quick-action:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        #infoPanel {
            position: absolute;
            left: 20px;
            bottom: 50px;
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
            border: 1px solid var(--panel-border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 300px;
            max-height: 300px;
            overflow-y: auto;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        #infoPanel.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        #infoPanel h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--primary);
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #infoPanel h3 button {
            background: none;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }

        #infoPanel h3 button:hover {
            color: var(--primary);
        }

        #infoPanel .info-row {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        #infoPanel .info-row:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        #infoPanel .info-label {
            width: 100px;
            color: var(--primary);
            font-weight: 600;
        }

        #infoPanel .info-value {
            flex: 1;
            word-break: break-word;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 229, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 229, 255, 0.5);
        }

        @media (max-width: 1024px) {
            #myNavCubeCanvas {
                width: 120px;
                height: 120px;
                bottom: 45px;
                right: 15px;
            }
            
            #infoPanel {
                width: 280px;
                max-height: 280px;
            }
        }

        @media (max-width: 768px) {
            #toolbar {
                height: 60px;
                padding: 0 5px;
            }
            
            #toolbar h1 {
                font-size: 1.2rem;
                max-width: 150px;
            }
            
            .toolbar-button {
                width: 40px;
                height: 40px;
                margin-left: 5px;
                font-size: 1rem;
            }
            
            #treeViewContainer {
                width: 280px;
                transform: translateX(-290px);
                top: 60px;
                height: calc(100% - 100px);
            }
            
            #infoPanel {
                width: 250px;
                left: 10px;
                bottom: 45px;
            }
            
            #myNavCubeCanvas {
                width: 100px;
                height: 100px;
                bottom: 45px;
                right: 10px;
            }
            
            #quickActions {
                right: 10px;
                top: 70px;
            }
            
            .quick-action {
                width: 40px;
                height: 40px;
            }
            
            #logo {
                font-size: 2.5rem;
            }
            
            #splashScreen p {
                font-size: 1rem;
            }
            
            #uploadButton {
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
            }
            
            #loadingStatus {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            #toolbar h1 {
                font-size: 1rem;
                max-width: 120px;
            }
            
            .toolbar-button {
                width: 36px;
                height: 36px;
                margin-left: 4px;
                font-size: 0.9rem;
            }
            
            #treeViewContainer {
                width: 250px;
                transform: translateX(-260px);
                padding: 15px;
            }
            
            #infoPanel {
                width: calc(100% - 20px);
                left: 10px;
                max-height: 250px;
            }
            
            #myNavCubeCanvas {
                width: 80px;
                height: 80px;
            }
            
            #quickActions {
                top: 65px;
            }
            
            .quick-action {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            #statusBar {
                font-size: 0.8rem;
                padding: 0 10px;
            }
            
            #stats .stat {
                margin-left: 10px;
                padding-left: 10px;
            }
            
            #logo {
                font-size: 2rem;
            }
            
            #splashScreen p {
                font-size: 0.9rem;
            }
            
            #uploadButton {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
            }
            
            #loadingStatus {
                font-size: 0.9rem;
            }
            
            #stats .stat:last-child {
                display: none;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</head>
<body>
    <canvas id="myCanvas"></canvas>
    <canvas id="myNavCubeCanvas"></canvas>
    <div id="treeViewContainer">
        <div id="treeViewHeader">
            <h3>Model Structure</h3>
            <div>
                <button id="toggleAllModels"><i class="fas fa-eye"></i></button>
                <button id="removeAllModels"><i class="fas fa-trash"></i></button>
                <button id="closeTreeView"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="treeViewContent"></div>
    </div>
    <div id="toolbar">
        <button id="toggleTreeView" class="toolbar-button">
            <i class="fas fa-sitemap"></i>
            <span class="tooltip">Model Structure</span>
        </button>
        <h1 id="modelName"><span>BIM</span> Explorer Pro</h1>
        <button id="resetView" class="toolbar-button">
            <i class="fas fa-home"></i>
            <span class="tooltip">Reset View</span>
        </button>
        <button id="toggleEdges" class="toolbar-button">
            <i class="fas fa-border-style"></i>
            <span class="tooltip">Toggle Edges</span>
        </button>
<!-- <button id="toggleDistanceMeasurements" class="toolbar-button">
    <i class="fas fa-ruler"></i>
    <span class="tooltip">Distance Measurements</span>
</button> -->
        <button id="toggleXray" class="toolbar-button">
            <i class="fas fa-x-ray"></i>
            <span class="tooltip">X-Ray Mode</span>
        </button>
        <button id="toggleInfo" class="toolbar-button">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip">Element Info</span>
        </button>
        <button id="openFile" class="toolbar-button">
            <i class="fas fa-folder-open"></i>
            <span class="tooltip">Open XKT File</span>
        </button>
    </div>
    <div id="quickActions">
        <button class="quick-action" id="zoomToFit">
            <i class="fas fa-expand"></i>
            <span class="tooltip">Zoom to Fit</span>
        </button>
        <button class="quick-action" id="takeScreenshot">
            <i class="fas fa-camera"></i>
            <span class="tooltip">Screenshot</span>
        </button>
    </div>
    <div id="infoPanel">
        <h3>
            Element Information
            <button id="closeInfoPanel"><i class="fas fa-times"></i></button>
        </h3>
        <div id="infoPanelContent">
            <div class="info-row">
                <div class="info-label">ID</div>
                <div class="info-value">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">Type</div>
                <div class="info-value">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">Material</div>
                <div class="info-value">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">Dimensions</div>
                <div class="info-value">-</div>
            </div>
        </div>
    </div>
    <div id="statusBar">
        <div id="status">
            <i class="fas fa-circle"></i> Ready
        </div>
        <div id="stats">
            <div class="stat">
                <i class="fas fa-cube"></i>
                <span id="objectCount">0 objects</span>
            </div>
            <div class="stat">
                <i class="fas fa-tachometer-alt"></i>
                <span id="fpsCounter">0 FPS</span>
            </div>
            <div class="stat">
                <i class="fas fa-user"></i> 
                Created by <a href="https://www.linkedin.com/in/shibinsha-connect" target="_blank" rel="noopener">Shah</a>
            </div>
        </div>
    </div>    
    <div id="splashScreen">
        <div id="logo">BIM <span>XKT Viewer</span></div>
        <p>xkt model loader for xeokit</p>
        <button id="uploadButton"><i class="fas fa-file-upload"></i> Load XKT Model</button>
    </div>
    <div id="dropZone">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Drop your XKT file here</p>
    </div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingStatus">Loading model...</p>
        <div id="loadingProgress">
            <div id="loadingProgressBar"></div>
        </div>
    </div>
    <input type="file" id="fileInput" accept=".xkt" multiple />
<script type="module">
    import {
        Viewer,
        XKTLoaderPlugin,
        NavCubePlugin,
        TreeViewPlugin,
        FastNavPlugin,
        DistanceMeasurementsPlugin
    } from "./xeokit-sdk.min.es.js";

    const viewer = new Viewer({
        canvasId: "myCanvas",
        transparent: true
    });

    const cameraControl = viewer.cameraControl;
    const scene = viewer.scene;
    const cameraFlight = viewer.cameraFlight;

    cameraControl.followPointer = true;
    cameraFlight.duration = 0.8;
    cameraFlight.fitFOV = 25;

    viewer.camera.eye = [-2.56, 8.38, 8.27];
    viewer.camera.look = [13.44, 3.31, -14.83];
    viewer.camera.up = [0.10, 0.98, -0.14];

    viewer.scene.xrayMaterial.fillAlpha = 0.1;
    viewer.scene.xrayMaterial.fillColor = [0, 0, 0];
    viewer.scene.xrayMaterial.edgeAlpha = 0.4;
    viewer.scene.xrayMaterial.edgeColor = [0, 229, 255];

    viewer.scene.highlightMaterial.fill = true;
    viewer.scene.highlightMaterial.fillAlpha = 0.3;
    viewer.scene.highlightMaterial.fillColor = [0, 229, 255];
    viewer.scene.highlightMaterial.edgeColor = [0, 229, 255];

    const navCube = new NavCubePlugin(viewer, {
        canvasId: "myNavCubeCanvas",
        visible: true,
        size: 150,
        alignment: "bottomRight",
        bottomMargin: 60,
        rightMargin: 20,
        frontColor: "#00e5ff",
        backColor: "#00b8d4",
        leftColor: "#7c4dff",
        rightColor: "#651fff",
        topColor: "#ff1744",
        bottomColor: "#d50000"
    });

    const treeView = new TreeViewPlugin(viewer, {
        containerElement: document.getElementById("treeViewContent"),
        autoExpandDepth: 0, // Start fully collapsed
        hierarchy: "containment"
    });

    const fastNav = new FastNavPlugin(viewer, {
        hideEdges: false, // Keep edges for clarity
        scaleCanvasResolution: true, // Optimize rendering
        scaleCanvasResolutionFactor: 0.5 // Balance quality and performance
    });

    const distanceMeasurements = new DistanceMeasurementsPlugin(viewer, {
        defaultAxis: "xy", // Default to XY plane for measurements
        labelVisible: true, // Show distance labels
        snapToEdge: true, // Snap to edges for precision
        snapToVertex: true // Snap to vertices
    });

    const dropZone = document.getElementById('dropZone');
    const splashScreen = document.getElementById('splashScreen');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const toggleTreeViewBtn = document.getElementById('toggleTreeView');
    const closeTreeViewBtn = document.getElementById('closeTreeView');
    const resetViewBtn = document.getElementById('resetView');
    const toggleEdgesBtn = document.getElementById('toggleEdges');
    const toggleXrayBtn = document.getElementById('toggleXray');
    const toggleInfoBtn = document.getElementById('toggleInfo');
    const openFileBtn = document.getElementById('openFile');
    const toggleDistanceMeasurementsBtn = document.getElementById('toggleDistanceMeasurements');
    const statusElement = document.getElementById('status');
    const objectCountElement = document.getElementById('objectCount');
    const fpsCounterElement = document.getElementById('fpsCounter');
    const treeViewContainer = document.getElementById('treeViewContainer');
    const modelNameElement = document.getElementById('modelName');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingStatus = document.getElementById('loadingStatus');
    const loadingProgressBar = document.getElementById('loadingProgressBar');
    const infoPanel = document.getElementById('infoPanel');
    const closeInfoPanelBtn = document.getElementById('closeInfoPanel');
    const infoPanelContent = document.getElementById('infoPanelContent');
    const zoomToFitBtn = document.getElementById('zoomToFit');
    const takeScreenshotBtn = document.getElementById('takeScreenshot');

    const xktLoader = new XKTLoaderPlugin(viewer);

    let models = {};
    let edgesEnabled = true;
    let xrayEnabled = false;
    let showInfoEnabled = false;
    let distanceMeasurementsEnabled = false;
    let lastTime = performance.now();
    let frameCount = 0;
    let loadQueue = [];
    let isLoading = false;
    let loadedModels = 0;
    let totalModelsToLoad = 0;
    const BATCH_SIZE = 3; // Reduced for stability
    const MAX_MODELS = 100; // Limit total models
    const LOAD_TIMEOUT = 30000; // 30 seconds per model

    // Toggle tree view
    toggleTreeViewBtn.addEventListener('click', () => {
        treeViewContainer.classList.toggle('visible');
        toggleTreeViewBtn.classList.toggle('active');
    });

    // Close tree view
    closeTreeViewBtn.addEventListener('click', () => {
        treeViewContainer.classList.remove('visible');
        toggleTreeViewBtn.classList.remove('active');
    });

    // Reset view
    resetViewBtn.addEventListener('click', () => {
        if (Object.keys(models).length > 0) {
            const combinedAABB = getCombinedAABB();
            if (combinedAABB) {
                viewer.cameraFlight.flyTo({
                    aabb: combinedAABB,
                    duration: 0.5
                });
            }
        } else {
            viewer.camera.eye = [-2.56, 8.38, 8.27];
            viewer.camera.look = [13.44, 3.31, -14.83];
            viewer.camera.up = [0.10, 0.98, -0.14];
        }
    });

    // Toggle edges for all models
    toggleEdgesBtn.addEventListener('click', () => {
        if (Object.keys(models).length === 0) {
            setStatus('No models loaded', true);
            return;
        }
        edgesEnabled = !edgesEnabled;
        Object.values(models).forEach(({ model }) => {
            if (model && !model.destroyed) {
                model.edges = edgesEnabled;
            }
        });
        toggleEdgesBtn.classList.toggle('active', edgesEnabled);
        setStatus(`Edges ${edgesEnabled ? 'enabled' : 'disabled'}`);
    });

    // Toggle X-ray mode for all models
    toggleXrayBtn.addEventListener('click', () => {
        if (Object.keys(models).length === 0) {
            setStatus('No models loaded', true);
            return;
        }
        xrayEnabled = !xrayEnabled;
        Object.values(models).forEach(({ model }) => {
            if (model && !model.destroyed) {
                model.xrayed = xrayEnabled;
            }
        });
        toggleXrayBtn.classList.toggle('active', xrayEnabled);
        setStatus(`X-ray ${xrayEnabled ? 'enabled' : 'disabled'}`);
    });

    // Toggle info panel
    toggleInfoBtn.addEventListener('click', () => {
        showInfoEnabled = !showInfoEnabled;
        toggleInfoBtn.classList.toggle('active', showInfoEnabled);
        if (!showInfoEnabled) {
            infoPanel.classList.remove('visible');
        }
    });

    // // Toggle distance measurements
    // toggleDistanceMeasurementsBtn.addEventListener('click', () => {
    //     if (Object.keys(models).length === 0) {
    //         setStatus('No models loaded', true);
    //         return;
    //     }
    //     distanceMeasurementsEnabled = !distanceMeasurementsEnabled;
    //     distanceMeasurements.active = distanceMeasurementsEnabled;
    //     toggleDistanceMeasurementsBtn.classList.toggle('active', distanceMeasurementsEnabled);
    //     setStatus(`Distance measurements ${distanceMeasurementsEnabled ? 'enabled' : 'disabled'}`);
    // });

    // Close info panel
    closeInfoPanelBtn.addEventListener('click', () => {
        infoPanel.classList.remove('visible');
        showInfoEnabled = false;
        toggleInfoBtn.classList.remove('active');
    });

    // Open file button
    openFileBtn.addEventListener('click', () => {
        fileInput.click();
    });

    // Upload button in splash screen
    uploadButton.addEventListener('click', () => {
        fileInput.click();
    });

    // Zoom to fit all models
    zoomToFitBtn.addEventListener('click', () => {
        if (Object.keys(models).length > 0) {
            const combinedAABB = getCombinedAABB();
            if (combinedAABB) {
                viewer.cameraFlight.flyTo({
                    aabb: combinedAABB,
                    duration: 0.5
                });
            }
        } else {
            setStatus('No models loaded', true);
        }
    });

    // Take screenshot
    takeScreenshotBtn.addEventListener('click', () => {
        const canvas = document.getElementById('myCanvas');
        const link = document.createElement('a');
        link.download = 'bim-explorer-screenshot.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        setStatus('Screenshot saved');
    });

    // File handling
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const files = Array.from(e.target.files).filter(file => file.name.toLowerCase().endsWith('.xkt'));
            if (files.length === 0) {
                setStatus('No valid XKT files selected', true);
                return;
            }
            if (files.length + Object.keys(models).length > MAX_MODELS) {
                if (!confirm(`Loading ${files.length} models will exceed the ${MAX_MODELS} model limit. Continue?`)) {
                    return;
                }
            }
            loadQueue.push(...files);
            totalModelsToLoad += files.length;
            updateModelName();
            processLoadQueue();
            fileInput.value = null;
        }
    });

    // Drag and drop functionality
    document.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
        if (e.dataTransfer.items.length > 0 && e.dataTransfer.items[0].kind === 'file') {
            dropZone.classList.add('highlight');
        }
    });

    document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        dropZone.classList.remove('highlight');
    });

    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        dropZone.classList.remove('highlight');

        if (e.dataTransfer.files.length > 0) {
            const files = Array.from(e.dataTransfer.files).filter(file => file.name.toLowerCase().endsWith('.xkt'));
            if (files.length === 0) {
                setStatus('No valid XKT files dropped', true);
                return;
            }
            if (files.length + Object.keys(models).length > MAX_MODELS) {
                if (!confirm(`Loading ${files.length} models will exceed the ${MAX_MODELS} model limit. Continue?`)) {
                    return;
                }
            }
            loadQueue.push(...files);
            totalModelsToLoad += files.length;
            updateModelName();
            processLoadQueue();
        }
    });

    // Batch loading models
    async function processLoadQueue() {
        if (isLoading || loadQueue.length === 0) return;

        isLoading = true;
        loadingOverlay.classList.add('visible');
        splashScreen.classList.add('hidden');

        const batch = loadQueue.splice(0, BATCH_SIZE);
        console.log(`Processing batch of ${batch.length} models`);

        const batchPromises = batch.map(file => {
            // Wrap loadModelFromFile with a timeout
            return Promise.race([
                loadModelFromFile(file),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(`Timeout loading ${file.name}`)), LOAD_TIMEOUT)
                )
            ]);
        });

        try {
            const results = await Promise.allSettled(batchPromises);
            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    console.error(`Failed to load ${batch[index].name}:`, result.reason);
                    setStatus(`Error loading ${batch[index].name}: ${result.reason.message}`, true);
                } else {
                    loadedModels++;
                }
            });
            updateProgressBar();

            if (loadQueue.length > 0) {
                // Increased delay for UI responsiveness
                setTimeout(processLoadQueue, 200);
            } else {
                isLoading = false;
                setTimeout(() => {
                    loadingOverlay.classList.remove('visible');
                    setStatus(`${loadedModels} model${loadedModels !== 1 ? 's' : ''} loaded successfully`);
                    loadedModels = 0;
                    totalModelsToLoad = 0;
                }, 500);
            }
        } catch (err) {
            console.error('Batch loading error:', err);
            setStatus('Error loading some models', true);
            isLoading = false;
            loadedModels = 0;
            totalModelsToLoad = 0;
            loadQueue = [];
            loadingOverlay.classList.remove('visible');
        }
    }

    // Load single model
    function loadModelFromFile(file) {
        return new Promise((resolve, reject) => {
            console.log(`Loading model: ${file.name}`);
            loadingStatus.textContent = `Loading ${file.name}...`;
            setStatus(`Loading ${file.name}...`);

            // Clean up oldest model if exceeding limit
            if (Object.keys(models).length >= MAX_MODELS) {
                const oldestId = Object.keys(models)[0];
                models[oldestId].model.destroy();
                delete models[oldestId];
                updateTreeViewNodes();
            }

            const modelId = `model_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const reader = new FileReader();

            reader.onload = (event) => {
                const arrayBuffer = event.target.result;
                const t0 = performance.now();

                try {
                    const model = xktLoader.load({
                        id: modelId,
                        xkt: arrayBuffer,
                        edges: edgesEnabled,
                        excludeUnclassifiedObjects: false
                    });

                    models[modelId] = { model, fileName: file.name };

                    model.on("loaded", () => {
                        const t1 = performance.now();
                        model.xrayed = xrayEnabled;
                        updateModelName();
                        updateObjectCount();
                        updateTreeViewNodes();
                        viewer.cameraFlight.flyTo({
                            aabb: getCombinedAABB(),
                            duration: 0.5
                        });
                        console.log(`Loaded ${file.name} in ${(t1 - t0) / 1000}s`);
                        resolve();
                    });

                    model.on("error", (err) => {
                        console.error(`Model loading error for ${file.name}:`, err);
                        setStatus(`Error loading ${file.name}: ${err.message}`, true);
                        delete models[modelId];
                        updateModelName();
                        updateObjectCount();
                        updateTreeViewNodes();
                        reject(err);
                    });
                } catch (err) {
                    console.error(`Error processing XKT file ${file.name}:`, err);
                    setStatus(`Error processing ${file.name}`, true);
                    reject(err);
                }
            };

            reader.onerror = () => {
                setStatus(`Error reading ${file.name}`, true);
                reject(new Error(`Error reading ${file.name}`));
            };

            reader.readAsArrayBuffer(file);
        });
    }

    // Update progress bar
    function updateProgressBar() {
        const progress = totalModelsToLoad > 0 ? (loadedModels / totalModelsToLoad) * 100 : 0;
        loadingProgressBar.style.width = `${Math.min(progress, 100)}%`;
        loadingStatus.textContent = `Loading ${loadedModels} of ${totalModelsToLoad} models...`;
    }

    // Mouse over entities to highlight them
    let lastEntity = null;

    viewer.scene.input.on("mousemove", (coords) => {
        if (distanceMeasurementsEnabled) return; // Disable highlighting during measurements
        const hit = viewer.scene.pick({
            canvasPos: coords
        });

        if (hit) {
            if (!lastEntity || hit.entity.id !== lastEntity.id) {
                if (lastEntity) {
                    lastEntity.highlighted = false;
                }

                lastEntity = hit.entity;
                hit.entity.highlighted = true;

                setStatus(`Entity: ${hit.entity.id}`);

                if (showInfoEnabled) {
                    updateInfoPanel(hit.entity);
                    infoPanel.classList.add('visible');
                }
            }
        } else {
            if (lastEntity) {
                lastEntity.highlighted = false;
                lastEntity = null;
                setStatus('Ready');

                if (showInfoEnabled) {
                    infoPanel.classList.remove('visible');
                }
            }
        }
    });

    // Update info panel
    function updateInfoPanel(entity) {
        const metaObjects = viewer.metaScene.metaObjects;
        const metaObject = metaObjects ? metaObjects[entity.id] : null;

        let html = '';
        html += `<div class="info-row">
                    <div class="info-label">ID</div>
                    <div class="info-value">${entity.id}</div>
                </div>`;

        if (metaObject) {
            html += `<div class="info-row">
                        <div class="info-label">Type</div>
                        <div class="info-value">${metaObject.type || '-'}</div>
                    </div>`;

            if (metaObject.properties) {
                for (const key in metaObject.properties) {
                    if (key !== 'id' && key !== 'type') {
                        html += `<div class="info-row">
                                    <div class="info-label">${key}</div>
                                    <div class="info-value">${metaObject.properties[key] || '-'}</div>
                                </div>`;
                    }
                }
            }
        } else {
            html += `<div class="info-row">
                        <div class="info-label">Type</div>
                        <div class="info-value">Unknown</div>
                    </div>`;
        }

        infoPanelContent.innerHTML = html;
    }

    // FPS counter
    viewer.scene.on("tick", () => {
        frameCount++;
        const now = performance.now();
        const elapsed = now - lastTime;

        if (elapsed >= 1000) {
            const fps = Math.round((frameCount * 1000) / elapsed);
            fpsCounterElement.textContent = `${fps} FPS`;
            frameCount = 0;
            lastTime = now;
        }
    });

    // Helper functions
    function setStatus(message, isError = false) {
        statusElement.innerHTML = `<i class="fas fa-${isError ? 'exclamation-circle' : 'circle'}"></i> ${message}`;
        if (isError) {
            statusElement.style.color = '#ff1744';
            setTimeout(() => {
                statusElement.style.color = '';
                statusElement.innerHTML = '<i class="fas fa-circle"></i> Ready';
            }, 5000);
        } else {
            statusElement.style.color = '';
        }
    }

    function getCombinedAABB() {
        const modelList = Object.values(models).filter(m => m.model && !m.model.destroyed);
        if (modelList.length === 0) {
            return null;
        }

        let minX = Infinity, minY = Infinity, minZ = Infinity;
        let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;

        modelList.forEach(({ model }) => {
            if (model && model.aabb) {
                const aabb = model.aabb;
                minX = Math.min(minX, aabb[0]);
                minY = Math.min(minY, aabb[1]);
                minZ = Math.min(minZ, aabb[2]);
                maxX = Math.max(maxX, aabb[3]);
                maxY = Math.max(maxY, aabb[4]);
                maxZ = Math.max(maxZ, aabb[5]);
            }
        });

        if (minX === Infinity) return null;
        return [minX, minY, minZ, maxX, maxY, maxZ];
    }

    function updateModelName() {
        const modelNames = Object.values(models).filter(m => m.model && !m.model.destroyed).map(m => m.fileName);
        if (modelNames.length === 0) {
            modelNameElement.innerHTML = `<span>BIM</span> Explorer Pro`;
        } else if (modelNames.length > 3) {
            modelNameElement.innerHTML = `<span>BIM</span> ${modelNames.length} models loaded`;
            modelNameElement.title = modelNames.join(', ');
        } else {
            modelNameElement.innerHTML = `<span>BIM</span> ${modelNames.join(', ')}`;
        }
    }

    function updateObjectCount() {
        const totalEntities = Object.values(models)
            .filter(m => m.model && !m.model.destroyed)
            .reduce((sum, { model }) => sum + (model.numEntities || 0), 0);
        objectCountElement.textContent = `${totalEntities} objects`;
    }

    // Custom tree view nodes for models
    function updateTreeViewNodes() {
        const container = document.getElementById('treeViewContent');
        const modelList = Object.values(models).filter(m => m.model && !m.model.destroyed);

        // Clear existing custom nodes
        const existingUl = container.querySelector('ul.custom-model-list');
        if (existingUl) {
            existingUl.remove();
        }

        // Create new model nodes
        const ul = document.createElement('ul');
        ul.className = 'custom-model-list';
        modelList.forEach(({ model, fileName }, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${fileName}</span>
                <span class="model-controls">
                    <button class="toggle-model-visibility" data-model-id="${model.id}"><i class="fas fa-eye${model.visible ? '' : '-slash'}"></i></button>
                    <button class="remove-model" data-model-id="${model.id}"><i class="fas fa-trash"></i></button>
                </span>
            `;
            ul.appendChild(li);
        });

        // Insert at top of tree view
        container.insertBefore(ul, container.firstChild);

        // Attach event listeners
        document.querySelectorAll('.toggle-model-visibility').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modelId = e.currentTarget.dataset.modelId;
                const modelData = models[modelId];
                if (modelData && modelData.model && !modelData.model.destroyed) {
                    modelData.model.visible = !modelData.model.visible;
                    e.currentTarget.querySelector('i').className = `fas fa-eye${modelData.model.visible ? '' : '-slash'}`;
                    setStatus(`${modelData.fileName} ${modelData.model.visible ? 'shown' : 'hidden'}`);
                }
            });
        });

        document.querySelectorAll('.remove-model').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modelId = e.currentTarget.dataset.modelId;
                const modelData = models[modelId];
                if (modelData && modelData.model && !modelData.model.destroyed) {
                    modelData.model.destroy();
                    delete models[modelId];
                    updateModelName();
                    updateObjectCount();
                    updateTreeViewNodes();
                    setStatus(`${modelData.fileName} removed`);
                    if (Object.keys(models).length === 0) {
                        splashScreen.classList.remove('hidden');
                        treeView.clear();
                    }
                }
            });
        });
    }

    // Model management controls
    function updateTreeViewHeader() {
        const header = document.getElementById('treeViewHeader');
        header.innerHTML = `
            <h3>Model Structure</h3>
            <div>
                <button id="toggleAllModels"><i class="fas fa-eye"></i></button>
                <button id="removeAllModels"><i class="fas fa-trash"></i></button>
                <button id="closeTreeView"><i class="fas fa-times"></i></button>
            </div>
        `;

        document.getElementById('closeTreeView').addEventListener('click', () => {
            treeViewContainer.classList.remove('visible');
            toggleTreeViewBtn.classList.remove('active');
        });

        document.getElementById('toggleAllModels').addEventListener('click', () => {
            const allVisible = Object.values(models)
                .filter(m => m.model && !m.model.destroyed)
                .every(({ model }) => model.visible);
            Object.values(models)
                .filter(m => m.model && !m.model.destroyed)
                .forEach(({ model }) => {
                    model.visible = !allVisible;
                });
            updateTreeViewNodes(); // Update visibility icons
            setStatus(`All models ${allVisible ? 'hidden' : 'shown'}`);
        });

        document.getElementById('removeAllModels').addEventListener('click', () => {
            Object.keys(models).forEach(modelId => {
                const { model } = models[modelId];
                if (model && !model.destroyed) {
                    model.destroy();
                }
            });
            models = {};
            updateModelName();
            updateObjectCount();
            updateTreeViewNodes();
            treeView.clear();
            setStatus('All models removed');
            splashScreen.classList.remove('hidden');
        });
    }

    updateTreeViewHeader();
</script>
</body>
</html>